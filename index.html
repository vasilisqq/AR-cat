<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR.js 3D Model Demo</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
    <!-- Индикатор загрузки -->
    <div class="arjs-loader">
        <div class="scanning-animation"></div>
        <div>Сканирую плоскость...</div>
        <div>Перемещайте камеру для обнаружения поверхности</div>
    </div>
    
    <!-- Блок для отображения ошибок - ИСПРАВЛЕНО -->
    <div class="error-overlay" id="errorOverlay">
        <div class="error-message">
            <div class="error-title" id="errorTitle">Произошла ошибка</div>
            <div class="error-text" id="errorText">Пожалуйста, попробуйте перезагрузить страницу</div>
            <div class="error-details" id="errorDetails"></div>
            <button class="reload-button" onclick="window.location.reload()">Перезагрузить</button>
        </div>
        <button class="close-button" onclick="document.getElementById('errorOverlay').style.display='none'">Закрыть</button>
    </div>
    
    <!-- Инструкция для пользователя -->
    <div class="instruction" id="instruction">Наведите на плоскость и коснитесь экрана для размещения модели 4</div>
    
    <!-- AR-сцена -->
    <a-scene 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded 
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        gesture-detector
    >
        <!-- Источник света -->
        <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.5" position="-1 2 1"></a-entity>
        
        <!-- Маркер для обнаружения плоскостей -->
        <a-entity id="marker" arjs-hit-test="target: #plane"></a-entity>
        
        <!-- Невидимая плоскость для размещения объектов -->
        <a-plane 
            id="plane" 
            position="0 0 0" 
            rotation="-90 0 0" 
            material="visible: false; transparent: true; opacity: 0.5"
            arjs-anchor
        ></a-plane>
        
        <!-- Камера -->
        <a-camera-static></a-camera-static>
    </a-scene>

    <script>
        // Функция для отображения ошибок - ИСПРАВЛЕНО
        function showError(title, message, details) {
            const errorOverlay = document.getElementById('errorOverlay');
            const errorTitle = document.getElementById('errorTitle');
            const errorText = document.getElementById('errorText');
            const errorDetails = document.getElementById('errorDetails');
            
            errorTitle.textContent = title;
            errorText.textContent = message;
            
            if (details) {
                errorDetails.textContent = details;
                errorDetails.style.display = 'block';
            } else {
                errorDetails.style.display = 'none';
            }
            
            errorOverlay.style.display = 'flex';
            document.querySelector('.arjs-loader').style.display = 'none';
            document.getElementById('instruction').style.display = 'none';
        }
        
        // Глобальная обработка ошибок
        window.addEventListener('error', function(event) {
            showError(
                'Непредвиденная ошибка', 
                'В работе приложения произошла ошибка. Попробуйте перезагрузить страницу.', 
                `Ошибка: ${event.message}\nФайл: ${event.filename}\nСтрока: ${event.lineno}`
            );
            console.error(event.error);
        });
        
        // Обработка ошибок в промисах
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason || {};
            showError(
                'Ошибка загрузки', 
                'Проблема при загрузке ресурсов. Проверьте подключение к интернету.', 
                reason.message || 'Неизвестная ошибка promise'
            );
            console.error(event.reason);
        });
        
        // Скрываем лоадер после загрузки сцены
        document.querySelector('a-scene').addEventListener('loaded', function() {
            document.querySelector('.arjs-loader').style.display = 'none';
            
            // Проверяем поддержку AR
            setTimeout(() => {
                if (!AFRAME.systems.arjs || !AFRAME.systems.arjs.isWebXRCameraActive) {
                    showError(
                        'AR не поддерживается', 
                        'Ваше устройство или браузер не поддерживают AR-функции.\nПопробуйте использовать:\n- Safari на iPhone (iOS 13+)\n- Chrome на Android (9.0+)', 
                        'Проверьте поддержку WebXR: https://caniuse.com/webxr'
                    );
                }
            }, 2000);
        });
        
        // Обработка жестов
        AFRAME.registerComponent('gesture-detector', {
            init: function() {
                this.el.addEventListener('click', (e) => {
                    if (!window.modelPlaced) {
                        try {
                            this.placeModel();
                        } catch (error) {
                            showError(
                                'Ошибка размещения модели', 
                                'Не удалось разместить модель. Убедитесь, что:\n1. Плоскость обнаружена\n2. Модель загружена', 
                                error.message
                            );
                        }
                    }
                });
            },
            
            placeModel: function() {
                const marker = document.getElementById('marker');
                const plane = document.getElementById('plane');
                
                // Проверка обнаружения плоскости
                if (!plane || !plane.object3D || !plane.object3D.position) {
                    throw new Error('Плоскость не обнаружена. Продолжайте сканировать поверхность.');
                }
                
                // Создаем модель
                const model = document.createElement('a-entity');
                model.setAttribute('gltf-model', '#model');
                model.setAttribute('scale', '0.5 0.5 0.5');
                model.setAttribute('position', plane.getAttribute('position'));
                model.setAttribute('rotation', '0 0 0');
                model.setAttribute('animation-mixer', 'clip: Appear; loop: once');
                model.setAttribute('shadow', 'receive: true');
                
                // Обработка ошибок загрузки модели
                model.addEventListener('model-error', function() {
                    showError(
                        'Ошибка загрузки модели', 
                        'Не удалось загрузить 3D-модель. Возможные причины:\n1. Проблемы с интернетом\n2. Неправильный URL модели\n3. Формат модели не поддерживается', 
                        'Проверьте консоль разработчика для деталей'
                    );
                });
                
                // Добавляем модель в сцену
                this.el.appendChild(model);
                
                // Скрываем инструкцию
                document.getElementById('instruction').style.display = 'none';
                
                // Флаг что модель размещена
                window.modelPlaced = true;
                
                // Запускаем дополнительную анимацию через 2 секунды
                setTimeout(() => {
                    try {
                        model.setAttribute('animation-mixer', 'clip: Idle; loop: repeat');
                    } catch (error) {
                        showError(
                            'Ошибка анимации', 
                            'Не удалось запустить анимацию модели. Проверьте:\n1. Наличие анимаций в модели\n2. Правильные имена анимаций', 
                            error.message
                        );
                    }
                }, 2000);
            }
        });
        
        // Таймер для проверки загрузки
        setTimeout(() => {
            if (document.querySelector('.arjs-loader').style.display !== 'none') {
                showError(
                    'Проблема с загрузкой', 
                    'AR-среда не загрузилась в течение ожидаемого времени. Возможные причины:\n1. Медленное интернет-соединение\n2. Браузер не поддерживает WebGL\n3. Нет разрешения на доступ к камере', 
                    'Проверьте консоль разработчика для деталей'
                );
            }
        }, 15000); // 15 секунд
        
        // Проверка поддержки WebGL
        if (!AFRAME.utils.device.checkWebGLSupport()) {
            showError(
                'WebGL не поддерживается', 
                'Ваш браузер не поддерживает необходимые технологии для работы AR.\nПопробуйте обновить браузер или использовать другое устройство.', 
                'Требуется поддержка WebGL 2.0'
            );
        }
        
        // Проверка поддержки getUserMedia (доступ к камере)
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError(
                'Доступ к камере невозможен', 
                'Ваш браузер не поддерживает доступ к камере или эта функция отключена.\nПроверьте настройки браузера.', 
                'Требуется поддержка MediaDevices API'
            );
        }
    </script>
    
    <!-- Ассеты - 3D модель -->
    <a-assets>
        <!-- Пример модели (замените на свою) -->
        <a-asset-item 
            id="model" 
            src="https://cdn.glitch.global/5e5ac1c9-8e34-4a0a-9b4c-13e0f6e6e9d0/robot.glb?v=1678203704340"
        ></a-asset-item>
    </a-assets>
</body>
</html>