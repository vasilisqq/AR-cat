<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальные метатеги и стили остаются без изменений) ... -->
</head>
<body>
    <!-- ... (HTML структура без изменений) ... -->

    <script>
        // Проверка устройства и браузера
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isSafari = !!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const loadingText = document.getElementById('loading-text');
        const infoPanel = document.getElementById('info-panel');
        const iosWarning = document.getElementById('ios-warning');
        const screenshotBtn = document.getElementById('screenshot-btn');
        let arInitialized = false; // Флаг инициализации

        // Основная функция инициализации
        async function initAR() {
            if (arInitialized) return;
            arInitialized = true;
            
            try {
                // Проверка платформы
                if (!isMobile) {
                    document.getElementById('desktop-message').style.display = 'flex';
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                // Показываем предупреждение для iOS
                if (isIOS) {
                    iosWarning.style.display = 'block';
                }

                // Проверка поддержки AR
                if (!checkARSupport()) {
                    showError("Ваш браузер не поддерживает AR. Пожалуйста, обновите iOS до версии 13.2+ или используйте Chrome на Android");
                    return;
                }

                // Настройка сцены
                configureSceneForPlatform();

                // Запускаем камеру
                await startCamera();

                // Показываем кнопку скриншота
                screenshotBtn.classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
                updateInfoPanel();

            } catch (error) {
                showError(`Ошибка инициализации: ${error.message}`);
                console.error(error);
            }
        }

        // Проверка поддержки AR (упрощенная)
        function checkARSupport() {
            // Все современные мобильные браузеры поддерживают getUserMedia
            return !!navigator.mediaDevices?.getUserMedia;
        }

        // Конфигурация сцены
        function configureSceneForPlatform() {
            const scene = document.getElementById('ar-scene');
            const model = document.getElementById('model');
            
            if (isIOS) {
                scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false;');
                model.setAttribute('visible', 'true');
            } else {
                scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false;');
                model.setAttribute('visible', 'true');
            }
        }

        // Запуск камеры (ключевые изменения)
        async function startCamera() {
            return new Promise((resolve, reject) => {
                const scene = document.getElementById('ar-scene');
                
                // Попытка получить поток камеры напрямую
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        // Создаем видео элемент для ручного управления
                        const video = document.createElement('video');
                        video.setAttribute('autoplay', '');
                        video.setAttribute('playsinline', '');
                        video.srcObject = stream;
                        
                        video.onloadedmetadata = () => {
                            // Ручная установка видео в AR.js
                            scene.setAttribute('arjs', `videoSource: #${video.id};`);
                            video.play();
                            document.body.appendChild(video);
                            video.style.display = 'none';
                            
                            // Специальное событие для iOS
                            if (isIOS) {
                                scene.addEventListener('camera-init', resolve);
                            } else {
                                resolve();
                            }
                        };
                    })
                    .catch(err => {
                        reject(new Error('Ошибка доступа к камере: ' + err.message));
                    });

                // Таймаут для отслеживания проблем
                setTimeout(() => {
                    if (document.querySelector('video')?.readyState >= 3) {
                        resolve();
                    } else {
                        reject(new Error('Таймаут инициализации камеры'));
                    }
                }, 10000);
            });
        }

        // ... (остальные функции без изменений: takeScreenshot, updateInfoPanel, showError) ...

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            // Для всех мобильных устройств используем единый подход
            if (isMobile) {
                // Показываем инструкцию для iOS
                if (isIOS) {
                    loadingText.textContent = "Нажмите на экран для запуска AR";
                    document.body.addEventListener('click', initAR, { once: true });
                } 
                // Для Android запускаем сразу
                else {
                    initAR();
                }
            } else {
                document.getElementById('desktop-message').style.display = 'flex';
                document.getElementById('loading').classList.add('hidden');
            }
        });

        // Обработчик кнопки скриншота
        screenshotBtn.addEventListener('click', takeScreenshot);
    </script>
</body>
</html>