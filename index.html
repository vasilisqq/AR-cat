<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Surface Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            touch-action: none;
        }
        
        #desktop-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 1000;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #ui-container {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
        }
        
        #screenshot-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            text-align: center;
            padding: 5px;
        }
        
        #error-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(200, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1002;
            display: none;
        }
        
        #debug-info {
            position: fixed;
            top: 40px;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        #toggle-debug {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1003;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="desktop-message">
        <h1>AR Experience</h1>
        <p>Это приложение работает только на мобильных устройствах. Пожалуйста, откройте его на смартфоне или планшете.</p>
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Инициализация AR...</p>
    </div>
    
    <div id="error-message"></div>
    
    <div id="debug-info"></div>
    
    <button id="toggle-debug">Показать логи</button>
    
    <canvas id="ar-canvas"></canvas>
    
    <div id="ui-container">
        <button id="screenshot-btn">Фото</button>
    </div>

    <script>
        // ====================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ====================
        let scene, camera, renderer;
        let arToolkitContext, arToolkitSource;
        let model = null;
        let modelPlaced = false;
        let debugInfo = document.getElementById('debug-info');
        let loadingText = document.getElementById('loading-text');
        let errorMessage = document.getElementById('error-message');
        
        // ====================
        // ОСНОВНАЯ ИНИЦИАЛИЗАЦИЯ
        // ====================
        async function init() {
            try {
                // 1. Проверка поддержки
                if (!await checkPrerequisites()) return;
                
                // 2. Инициализация Three.js
                initThreeJS();
                
                // 3. Инициализация AR.js
                initARJS();
                
                // 4. Настройка сцены
                setupScene();
                
                // 5. Загрузка модели
                loadModel();
                
                // 6. Запуск рендеринга
                startRendering();
                
                // 7. Скрыть загрузчик
                document.getElementById('loading').classList.add('hidden');
                
            } catch (error) {
                showError(`Ошибка инициализации: ${error.message}`);
                console.error(error);
            }
        }
        
        // ====================
        // ПРОВЕРКА ПРЕДПОСЫЛОК
        // ====================
        async function checkPrerequisites() {
            // Проверка мобильного устройства
            if (!isMobile()) {
                document.getElementById('desktop-message').style.display = 'flex';
                document.getElementById('loading').classList.add('hidden');
                return false;
            }
            
            updateLoadingText("Проверка поддержки WebXR...");
            
            // Проверка поддержки WebXR
            if (!navigator.xr) {
                showError("WebXR не поддерживается вашим браузером");
                return false;
            }
            
            // Проверка поддержки WebGL
            if (!WEBGL.isWebGLAvailable()) {
                showError("WebGL не поддерживается вашим устройством");
                return false;
            }
            
            // Запрос разрешения на камеру
            try {
                updateLoadingText("Запрос доступа к камере...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                showError("Доступ к камере запрещен. Разрешите доступ к камере в настройках браузера.");
                return false;
            }
            
            return true;
        }
        
        // ====================
        // ИНИЦИАЛИЗАЦИЯ THREE.JS
        // ====================
        function initThreeJS() {
            // 1. Сцена
            scene = new THREE.Scene();
            
            // 2. Камера
            camera = new THREE.PerspectiveCamera(
                60, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                100
            );
            
            // 3. Рендерер
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('ar-canvas'),
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
        }
        
        // ====================
        // ИНИЦИАЛИЗАЦИЯ AR.JS
        // ====================
        function initARJS() {
            updateLoadingText("Инициализация AR...");
            
            // 1. Источник видео (камера)
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
                displayWidth: window.innerWidth,
                displayHeight: window.innerHeight
            });
            
            // Обработчики событий для источника
            arToolkitSource.init(() => {
                console.log("AR источник инициализирован");
                arToolkitSource.onResize();
            }, (error) => {
                showError(`Ошибка инициализации камеры: ${error.message}`);
            });
            
            // 2. Контекст AR
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: window.innerWidth,
                canvasHeight: window.innerHeight
            });
            
            // Инициализация контекста
            arToolkitContext.init(() => {
                console.log("AR контекст инициализирован");
                // Копируем матрицу проекции камеры
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });
        }
        
        // ====================
        // НАСТРОЙКА СЦЕНЫ
        // ====================
        function setupScene() {
            // Освещение
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Ретикула для индикации поверхности
            const reticleGeometry = new THREE.RingGeometry(0.05, 0.1, 32);
            const reticleMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                opacity: 0.8,
                transparent: true
            });
            
            const reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
            reticle.rotation.x = -Math.PI / 2;
            reticle.position.z = -0.5;
            reticle.visible = false;
            scene.add(reticle);
            
            // Обработчик кликов для размещения модели
            window.addEventListener('click', () => {
                if (!model || modelPlaced) return;
                
                // Размещаем модель в позиции ретикулы
                model.position.copy(reticle.position);
                model.visible = true;
                modelPlaced = true;
                reticle.visible = false;
            });
        }
        
        // ====================
        // ЗАГРУЗКА МОДЕЛИ
        // ====================
        function loadModel() {
            updateLoadingText("Загрузка модели...");
            
            // Простая 3D модель куба с анимацией
            const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
            const material = new THREE.MeshStandardMaterial({
                color: 0x00aaff,
                metalness: 0.7,
                roughness: 0.3
            });
            
            model = new THREE.Mesh(geometry, material);
            model.visible = false; // Скрываем до размещения
            scene.add(model);
            
            // Анимация вращения
            model.userData.animate = true;
            
            console.log("Модель загружена");
        }
        
        // ====================
        // ЗАПУСК РЕНДЕРИНГА
        // ====================
        function startRendering() {
            // Функция рендеринга
            function animate() {
                requestAnimationFrame(animate);
                
                try {
                    // Обновление AR сцены
                    if (arToolkitSource.ready) {
                        arToolkitContext.update(arToolkitSource.domElement);
                        
                        // Обновляем позицию ретикулы (простая имитация)
                        const reticle = scene.children.find(child => child.type === 'Mesh' && child.geometry.type === 'RingGeometry');
                        if (reticle && !modelPlaced) {
                            reticle.visible = true;
                            // Простое движение ретикулы для демонстрации
                            reticle.position.z = -0.5 + Math.sin(Date.now() * 0.002) * 0.1;
                        }
                        
                        // Анимация модели
                        if (model && model.visible && model.userData.animate) {
                            model.rotation.y += 0.01;
                            model.rotation.x += 0.005;
                        }
                    }
                    
                    // Рендеринг сцены
                    renderer.render(scene, camera);
                    
                    // Обновление информации для отладки
                    updateDebugInfo();
                    
                } catch (error) {
                    console.error("Ошибка в цикле рендеринга:", error);
                }
            }
            
            // Запускаем цикл анимации
            animate();
        }
        
        // ====================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // ====================
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            document.getElementById('loading').classList.add('hidden');
            console.error(message);
        }
        
        function updateLoadingText(text) {
            loadingText.textContent = text;
            console.log(text);
        }
        
        function updateDebugInfo() {
            const info = `
                AR состояние: ${arToolkitSource.ready ? 'Готово' : 'Загрузка...'}
                Поддержка WebXR: ${navigator.xr ? 'Да' : 'Нет'}
                Модель: ${model ? 'Загружена' : 'Нет'}
                Размещена: ${modelPlaced ? 'Да' : 'Нет'}
                FPS: ${Math.round(THREEx.ArToolkitContext.baseGetPerformance())}
            `;
            debugInfo.textContent = info;
        }
        
        // ====================
        // ОБРАБОТЧИКИ СОБЫТИЙ
        // ====================
        // Скриншот
        document.getElementById('screenshot-btn').addEventListener('click', () => {
            try {
                // Создаем временный canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                // Копируем изображение с рендерера
                ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);
                
                // Создаем ссылку для скачивания
                const link = document.createElement('a');
                link.download = 'ar-screenshot.png';
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                showError("Ошибка создания скриншота");
            }
        });
        
        // Переключение отладочной информации
        document.getElementById('toggle-debug').addEventListener('click', () => {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        });
        
        // Обработка изменения размера окна
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            if (arToolkitContext) {
                arToolkitContext.arController.setProjectionMatrix();
            }
        });
        
        // Запуск приложения
        window.addEventListener('load', init);
    </script>
</body>
</html>